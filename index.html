<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signage Management</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link rel="preconnect" href="https://script.google.com">
<link rel="preconnect" href="https://drive.google.com">
<link rel="dns-prefetch" href="https://lh3.googleusercontent.com">
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box
    }

    body {
        font-family: system-ui, sans-serif;
        background: #f5f5f5;
        padding: 20px;
        min-height: 100vh
    }

    .container {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
        max-width: 500px;
        margin: 0 auto 20px
    }

    h1 {
        font-size: 22px;
        margin-bottom: 20px;
        color: #333
    }

    h2 {
        font-size: 20px;
        margin-bottom: 16px;
        color: #333;
        text-align: center
    }

    .role-select {
        display: flex;
        gap: 12px;
        margin-bottom: 20px
    }

    .role-btn {
        flex: 1;
        padding: 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: .3s
    }

    .role-btn.active {
        border-color: #4CAF50;
        background: #f0f8f0;
        color: #4CAF50
    }

    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: .3s;
        margin-bottom: 20px
    }

    .upload-area:hover {
        border-color: #666;
        background: #fafafa
    }

    input[type="file"] {
        display: none
    }

    .preview {
        max-width: 100%;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none
    }

    select, button, input[type="text"], input[type="number"] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        margin-bottom: 12px
    }

    button {
        background: #4CAF50;
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: .3s
    }

    button:hover {
        background: #45a049
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed
    }

    .success {
        background: #4CAF50;
        color: #fff;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
        margin-top: 12px;
        font-weight: 600
    }

    .error {
        background: #f44336;
        color: #fff;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
        margin-top: 12px
    }

    .step {
        display: none
    }

    .step.active {
        display: block
    }

    .filters {
        background: #f9f9f9;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px
    }

    .signage-card {
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: .3s
    }

    .signage-card:hover {
        border-color: #4CAF50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, .2)
    }

    .signage-card.selected {
        border-color: #4CAF50;
        background: #f0f8f0
    }

        #signageTable tbody tr {
    border-bottom: 1px solid #e0e0e0;
    cursor: pointer;
    transition: .2s;
}

#signageTable tbody tr:hover {
    background: #f9f9f9;
}

#signageTable th {
    font-weight: 600;
    font-size: 14px;
    color: #666;
}

#signageTable td {
    padding: 12px;
    font-size: 14px;
    color: #333;
}

#signageTable .code-cell {
    font-weight: 700;
    color: #4CAF50;
    font-size: 16px;
}

    .signage-code {
        font-size: 20px;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px
    }

    .signage-specs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 14px;
        color: #666
    }

    .signage-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px
    }

    .signage-status.pending {
        background: #FFF3CD;
        color: #856404
    }

    .signage-status.submitted {
        background: #D1ECF1;
        color: #0C5460
    }

    .signage-status.completed {
        background: #D4EDDA;
        color: #155724
    }

    .gallery {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px
    }

    .gallery-item {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .1)
    }

    .gallery-item img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        cursor: pointer
    }

    .gallery-item img[data-src] {
        background: #f0f0f0
    }

    .gallery-item-info {
        padding: 16px
    }

    .gallery-item-code {
        font-weight: 700;
        font-size: 18px;
        color: #333;
        margin-bottom: 8px
    }

    .gallery-item-specs {
        font-size: 13px;
        color: #666;
        margin-bottom: 8px
    }

    .status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 12px
    }

    .status.pending {
        background: #FFF3CD;
        color: #856404
    }

    .status.approved {
        background: #D4EDDA;
        color: #155724
    }

    .status.rejected {
        background: #F8D7DA;
        color: #721C24
    }

    .action-btns {
        display: flex;
        gap: 8px;
        margin-top: 12px
    }

    .action-btns button {
        margin-bottom: 0;
        padding: 10px;
        font-size: 14px
    }

    .approve-btn {
        background: #4CAF50
    }

    .reject-btn {
        background: #f44336
    }

    .reject-btn:hover {
        background: #d32f2f
    }

    .back-btn {
        background: #666;
        margin-top: 12px
    }

    .back-btn:hover {
        background: #555
    }

    .comment-input {
        margin-top: 8px;
        display: none
    }

    .view-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        max-width: 1200px;
        margin: 0 auto 16px
    }

    .view-tab {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
        text-align: center;
        font-weight: 600
    }

    .view-tab.active {
        background: #4CAF50;
        color: #fff;
        border-color: #4CAF50
    }

    .empty {
        text-align: center;
        color: #999;
        padding: 40px;
        background: #fff;
        border-radius: 12px
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, .8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px
    }

    .modal.active {
        display: flex
    }

    .modal-content {
        background: #fff;
        border-radius: 12px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        position: relative
    }

    .modal-image {
        width: 100%;
        height: auto;
        display: block
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #fff;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .3);
        z-index: 10
    }

    .api-status {
        background: #E3F2FD;
        border-left: 4px solid #2196F3;
        padding: 12px;
        margin-bottom: 16px;
        font-size: 14px;
        border-radius: 4px
    }

    .drive-link {
        display: inline-block;
        margin-top: 8px;
        padding: 6px 12px;
        background: #4285F4;
        color: #fff;
        text-decoration: none;
        border-radius: 4px;
        font-size: 12px
    }

    .drive-link:hover {
        background: #357AE8
    }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè≠ Signage Management</h1>

        <div class="api-status" id="apiStatus">
    üîÑ Connecting to database...
    <button onclick="loadData()" style="margin-left:12px; padding:4px 12px; background:#2196F3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:12px">
        üîÑ Retry
    </button>
</div>

        <div class="role-select">
            <button class="role-btn active" onclick="setRole('worker')">üë∑ Factory Worker</button>
            <button class="role-btn" onclick="setRole('supervisor')">üëî Supervisor</button>
        </div>

        <div id="workerView">
            <div id="workerStep1" class="step active">
                <h2>Select Signage</h2>
               <div class="filters">
    <select id="filterStation" onchange="applyFilters()">
        <option value="">All Stations</option>
    </select>
    <select id="filterType" onchange="applyFilters()">
        <option value="">All Types</option>
    </select>
    <select id="filterWidth" onchange="applyFilters()">
        <option value="">All Widths</option>
    </select>
    <select id="filterHeight" onchange="applyFilters()">
        <option value="">All Heights</option>
    </select>
    <select id="filterIllumination" onchange="applyFilters()">
        <option value="">All Illumination</option>
    </select>
    <select id="filterMounting" onchange="applyFilters()">
        <option value="">All Mounting</option>
    </select>
    <select id="filterSides" onchange="applyFilters()">
        <option value="">All Sides</option>
    </select>
</div>
                <div id="signageList">
    <table id="signageTable" style="width:100%; border-collapse:collapse; background:#fff">
        <thead>
            <tr style="background:#f5f5f5; border-bottom:2px solid #ddd">
                <th style="padding:12px; text-align:left; cursor:pointer" onclick="sortTable('code')">Code ‚ñæ</th>
                <th style="padding:12px; text-align:left; cursor:pointer" onclick="sortTable('station')">Station ‚ñæ</th>
                <th style="padding:12px; text-align:left; cursor:pointer" onclick="sortTable('width')">Width ‚ñæ</th>
                <th style="padding:12px; text-align:left; cursor:pointer" onclick="sortTable('height')">Height ‚ñæ</th>
                <th style="padding:12px; text-align:left; cursor:pointer" onclick="sortTable('illumination')">Type ‚ñæ</th>
                <th style="padding:12px; text-align:left">Status</th>
            </tr>
        </thead>
        <tbody id="signageTableBody"></tbody>
    </table>
</div>
            </div>

            <div id="workerStep2" class="step">
                <h2>Upload Photo</h2>
                <div id="selectedSignageInfo"></div>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <p>üì∑ Tap to capture photo</p>
                    <input type="file" id="fileInput" accept="image/*" capture="environment">
                </div>
                <img id="preview" class="preview">
                <button id="submitBtn" style="display:none" onclick="submitUpload()">Submit Photo</button>
                <button class="back-btn" onclick="backToList()">‚Üê Back to List</button>
            </div>
        </div>

        <div id="supervisorView" style="display:none">
            <div id="supervisorStep1" class="step active">
                <h2>Add New Signage</h2>
                <input type="text" id="newCode" placeholder="Signage Code (e.g., CCB-004)">
                <div class="form-row">
                    <input type="number" id="newWidth" placeholder="Width (m)" step="0.1">
                    <input type="number" id="newHeight" placeholder="Height (m)" step="0.1">
                </div>
                <select id="newIllumination">
                    <option value="">Illumination?</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
                <button onclick="addSignage()">Add Signage</button>
                <div id="supervisorMessage"></div>
            </div>
            <!-- Bulk Import from Excel -->
<div class="container" style="margin-top:12px">
  <h2>Bulk Import Signage (Excel)</h2>
  <div class="filters" style="margin-bottom:12px">
    <p style="font-size:14px;color:#555;margin-bottom:8px">
      Required columns (exact names): <b>Station, Code, Type, Width, Height, Illumination, Mounting, Sides</b><br>
      File types: .xlsx, .xls, .csv
    </p>
    <input
  type="file"
  id="excelInput"
  accept=".xlsx,.xls,.csv"
  onchange="importSignageFromExcel()"
  style="display:block; position:absolute; left:-9999px; opacity:0;"
/>

    <button style="margin-top:8px" onclick="document.getElementById('excelInput').click()">Choose file &amp; Import</button>

  </div>
  <div id="excelImportStatus" class="api-status">Waiting for file‚Ä¶</div>
</div>

        </div>
    </div>

    <div style="max-width:1200px;margin:20px auto">
        <h2 id="galleryTitle">üìã Review Uploads</h2>
        <div class="view-tabs" id="viewTabs" style="display:none">
            <button class="view-tab active" onclick="setView('pending')">Pending</button>
            <button class="view-tab" onclick="setView('approved')">Approved</button>
            <button class="view-tab" onclick="setView('rejected')">Rejected</button>
            <button class="view-tab" onclick="setView('all')">All</button>
        </div>
        <div id="gallery" class="gallery"></div>
        <div id="emptyGallery" class="empty" style="display:none">No uploads yet</div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modalImage" class="modal-image">
        </div>
    </div>

    <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbylzTLaiVd1iXdI4rYhripLQz3mlMlUXgt68hhVh4PO5OQdpvT7mREC2Wd_Up07Lgfe-A/exec';
    let currentRole = 'worker';
    let currentView = 'pending';
    let allSignage = [];
    let allUploads = [];
    let selectedSignage = null;
    let selectedImage = null;
    let signageByCode = {};
        let selectedFile = null;

// ---- Supabase init ----
const SUPABASE_URL = "https://vxkkmqtzjxfiiyggswcx.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4a2ttcXR6anhmaWl5Z2dzd2N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDU5NzgsImV4cCI6MjA3ODAyMTk3OH0.Gv1wjTo2XqKQbkaq1bgxe5RtZk_v8LUwF3BKnLNTD5I";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        // Test connection
sb.from('signage').select('count', { count: 'exact', head: true })
  .then(result => {
    if (result.error) {
      console.error('Supabase connection error:', result.error);
      document.getElementById('apiStatus').innerHTML = 
        '‚ùå Database connection failed: ' + result.error.message;
    }
  });
// Instant render from last good data (if available)
try {
  const cached = localStorage.getItem('signage_cache_v1');
  if (cached) {
    const {signage, uploads} = JSON.parse(cached);
    if (Array.isArray(signage) && Array.isArray(uploads)) {
      allSignage = signage;
      signageByCode = Object.fromEntries(allSignage.map(s => [s.code, s]));
      allUploads = uploads;
      if (allSignage.length > 0) {
        populateFilters();
      }
      applyFilters();
      resetPagination();
      loadGallery();
      document.getElementById('apiStatus').innerHTML = 'üì¶ Loaded from cache - refreshing...';
    }
  }
} catch(e) {
  console.log('Cache error:', e);
}

const PAGE_SIZE = 20;
let page = 1;
let itemsForView = [];

function resetPagination(){
  page = 1;
  itemsForView = (currentView==='all') ? allUploads : allUploads.filter(u=>u.status===currentView);
}
    const urlCache = new Map();
    function convertDriveUrl(url) {
        if (!url)
            return '';
        if (urlCache.has(url))
            return urlCache.get(url);
        const match = url.match(/\/d\/([^\/]+)/);
const result=match?`https://drive.google.com/thumbnail?id=${match[1]}&sz=w256`:url;
        urlCache.set(url, result);
        return result;
    }
        // -------- Excel Importer for Supervisor --------

// Map & normalize headers to our expected keys
function normalizeHeader(h) {
  if (!h) return '';
  return String(h).trim().toLowerCase()
    .replace(/\s+/g,' ')        // collapse spaces
    .replace(/[^a-z0-9 ]/g,'')  // drop symbols
    .trim();
}

// Convert Illumination, Sides etc. to standard values
function yn(val) {
  const s = String(val || '').trim().toLowerCase();
  if (['y','yes','true','1'].includes(s)) return 'Yes';
  if (['n','no','false','0'].includes(s)) return 'No';
  return val ? String(val) : ''; // leave as is if custom
}
function toNumber(v) {
  const n = parseFloat(v);
  return isFinite(n) ? n : null;
}

// Validate a row has the essentials
function validateRow(r) {
  // Code is required (primary key)
  if (!r.code) return 'Missing Code';
  if (r.width!==null && r.width<0) return 'Width must be >= 0';
  if (r.height!==null && r.height<0) return 'Height must be >= 0';
  return null;
}

async function importSignageFromExcel(){
  const status = document.getElementById('excelImportStatus');
  const input = document.getElementById('excelInput');
  const file = input.files && input.files[0];
  if (!file) { status.textContent = '‚ùå No file selected.'; return; }

  status.textContent = 'üîÑ Reading file‚Ä¶';

  try {
    // Read file
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type: 'array' });

    // Use first sheet
    const wsName = wb.SheetNames[0];
    const ws = wb.Sheets[wsName];

    // Convert to JSON (raw keys)
    const rowsRaw = XLSX.utils.sheet_to_json(ws, { defval: '' }); // keep empty cells as ''
    if (!rowsRaw.length) { status.textContent = '‚ùå No rows found.'; return; }

    // Build header map: original -> normalized
    const headerMap = {};
    Object.keys(rowsRaw[0]).forEach(k => headerMap[k] = normalizeHeader(k));

    // Reverse lookup to find required headers exist
    const needed = ['station','code','type','width','height','illumination','mounting','sides'];
    const available = new Set(Object.values(headerMap));
    const missing = needed.filter(k => !available.has(k));
    if (missing.length) {
      status.innerHTML = '‚ùå Missing columns: <b>'+missing.join(', ')+'</b>';
      return;
    }

    // Transform rows
    const toKey = (origKey) => headerMap[origKey];
    const prepared = rowsRaw.map(row => {
      const normalized = {};
      for (const orig in row) {
        const key = toKey(orig);
        if (!key) continue;
        normalized[key] = row[orig];
      }
      // Coerce types & normalize
      return {
        station: String(normalized.station || '').trim(),
        code: String(normalized.code || '').trim(),
        type: String(normalized.type || '').trim(),
        width: toNumber(normalized.width),
        height: toNumber(normalized.height),
        illumination: yn(normalized.illumination) || String(normalized.illumination || '').trim(),
        mounting: String(normalized.mounting || '').trim(),
        sides: String(normalized.sides || '').trim(), // expect 'Single'/'Double' or similar
        status: 'pending'
      };
    });

    // Basic validation & dedupe
    const errors = [];
    const seen = new Set();
    const deduped = [];
    for (const r of prepared) {
      const err = validateRow(r);
      if (err) { errors.push(`Code ${r.code || '(blank)'}: ${err}`); continue; }
      if (seen.has(r.code)) continue; // keep first occurrence
      seen.add(r.code);
      deduped.push(r);
    }
    if (errors.length) {
      status.innerHTML = '‚ö†Ô∏è Some rows skipped:<br>'+errors.slice(0,10).map(e=>'- '+e).join('<br>') + (errors.length>10?'<br>‚Ä¶':'' );
    } else {
      status.textContent = '‚úÖ Data validated. Importing‚Ä¶';
    }

    // Upsert in chunks to avoid payload limits
    const CHUNK = 200;
    let imported = 0;
    for (let i=0; i<deduped.length; i+=CHUNK) {
      const slice = deduped.slice(i, i+CHUNK);
      // Requires Supabase client 'sb' already initialized
      const { error } = await sb.from('signage')
        .upsert(slice, { onConflict: 'code' }); // update if exists, insert if new
      if (error) throw error;
      imported += slice.length;
      status.textContent = `‚úÖ Imported ${imported}/${deduped.length}‚Ä¶`;
    }

    status.textContent = `‚úÖ Done. Imported ${imported} rows. Refreshing list‚Ä¶`;
    await loadData();
  } catch (err) {
    console.error(err);
    status.textContent = '‚ùå Import failed: ' + err.message;
  }
}

 async function loadData(){
  const statusEl = document.getElementById('apiStatus');

  try {
    statusEl.innerHTML = "üîÑ Fetching latest...";

    const [signageRes, uploadsRes] = await Promise.all([
      sb.from('signage').select('*'),
      sb.from('uploads').select('*').order('upload_date', { ascending: false })
    ]);

    // Check for errors in response
    if (signageRes.error) throw signageRes.error;
    if (uploadsRes.error) throw uploadsRes.error;

    allSignage = signageRes.data || [];
    signageByCode = Object.fromEntries(allSignage.map(s => [s.code, s]));
    allUploads = uploadsRes.data || [];

    // Cache successful data
    try {
      localStorage.setItem('signage_cache_v1', JSON.stringify({
        signage: allSignage,
        uploads: allUploads
      }));
    } catch(e) {
      console.log('Cache save failed:', e);
    }

    populateFilters();
    applyFilters();
    resetPagination();
    loadGallery();

    statusEl.innerHTML = "‚úÖ Synced with database";
  }
  catch(err){
    console.error('Load error:', err);
    statusEl.innerHTML = "‚ö†Ô∏è Using cached data - " + (err.message || 'Connection issue');
    
    // Try to use cached data if available
    if (allSignage.length === 0) {
      try {
        const cached = localStorage.getItem('signage_cache_v1');
        if (cached) {
          const {signage, uploads} = JSON.parse(cached);
          allSignage = signage || [];
          signageByCode = Object.fromEntries(allSignage.map(s => [s.code, s]));
          allUploads = uploads || [];
        }
      } catch(e) {
        console.log('Cache load failed:', e);
      }
    }
    
    // Still show UI even if there's an error
    if (allSignage.length > 0) {
      populateFilters();
      applyFilters();
      resetPagination();
      loadGallery();
    } else {
      statusEl.innerHTML = "‚ùå No data available - Please check connection";
    }
  }
}    
        function setRole(role) {
        currentRole = role;
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('workerView').style.display = role === 'worker' ? 'block' : 'none';
        document.getElementById('supervisorView').style.display = role === 'supervisor' ? 'block' : 'none';
        document.getElementById('viewTabs').style.display = role === 'supervisor' ? 'flex' : 'none';
        document.getElementById('galleryTitle').textContent = role === 'worker' ? 'üìã My Submissions' : 'üìã Review Uploads';
        if (role === 'supervisor')
            setView('pending');
        else
            loadGallery();
    }
    function populateFilters() {
      // Don't populate if no data yet
    if (!allSignage || allSignage.length === 0) {
        return;
    }
        // Get unique values for each filter
    const stations = [...new Set(allSignage.map(s => s.station).filter(Boolean))].sort();
    const types = [...new Set(allSignage.map(s => s.type).filter(Boolean))].sort();
    const widths = [...new Set(allSignage.map(s => s.width).filter(Boolean))].sort((a,b) => parseFloat(a) - parseFloat(b));
    const heights = [...new Set(allSignage.map(s => s.height).filter(Boolean))].sort((a,b) => parseFloat(a) - parseFloat(b));
    const illuminations = [...new Set(allSignage.map(s => s.illumination).filter(Boolean))].sort();
    const mountings = [...new Set(allSignage.map(s => s.mounting).filter(Boolean))].sort();
    const sides = [...new Set(allSignage.map(s => s.sides).filter(Boolean))].sort();
    
    // Populate Station
    const stationSelect = document.getElementById('filterStation');
    stationSelect.innerHTML = '<option value="">All Stations</option>' + 
        stations.map(v => `<option value="${v}">${v}</option>`).join('');
    
    // Populate Type
    const typeSelect = document.getElementById('filterType');
    typeSelect.innerHTML = '<option value="">All Types</option>' + 
        types.map(v => `<option value="${v}">${v}</option>`).join('');
    
    // Populate Width
    const widthSelect = document.getElementById('filterWidth');
    widthSelect.innerHTML = '<option value="">All Widths</option>' + 
        widths.map(v => `<option value="${v}">${v}m</option>`).join('');
    
    // Populate Height
    const heightSelect = document.getElementById('filterHeight');
    heightSelect.innerHTML = '<option value="">All Heights</option>' + 
        heights.map(v => `<option value="${v}">${v}m</option>`).join('');
    
    // Populate Illumination
    const illumSelect = document.getElementById('filterIllumination');
    illumSelect.innerHTML = '<option value="">All Illumination</option>' + 
        illuminations.map(v => `<option value="${v}">${v}</option>`).join('');
    
    // Populate Mounting
    const mountingSelect = document.getElementById('filterMounting');
    mountingSelect.innerHTML = '<option value="">All Mounting</option>' + 
        mountings.map(v => `<option value="${v}">${v}</option>`).join('');
    
    // Populate Sides
    const sidesSelect = document.getElementById('filterSides');
    sidesSelect.innerHTML = '<option value="">All Sides</option>' + 
        sides.map(v => `<option value="${v}">${v}</option>`).join('');
}
        let filterTimeout;
function applyFilters() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
        const station = document.getElementById('filterStation').value;
        const type = document.getElementById('filterType').value;
        const width = document.getElementById('filterWidth').value;
        const height = document.getElementById('filterHeight').value;
        const illum = document.getElementById('filterIllumination').value;
        const mounting = document.getElementById('filterMounting').value;
        const sides = document.getElementById('filterSides').value;
        
        let filtered = allSignage.filter(s => {
            let match = true;
            if (station && s.station !== station) match = false;
            if (type && s.type !== type) match = false;
            if (width && s.width != width) match = false;
            if (height && s.height != height) match = false;
            if (illum && s.illumination !== illum) match = false;
            if (mounting && s.mounting !== mounting) match = false;
            if (sides && s.sides !== sides) match = false;
            return match;
        });
        
        displaySignageList(filtered);
    }, 150);
}

let sortColumn = 'code';
let sortDirection = 'asc';

function sortTable(column) {
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'asc';
    }
    applyFilters();
}

function displaySignageList(list) {
    const tbody = document.getElementById('signageTableBody');
    
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#999">No signage found</td></tr>';
        return;
    }
    
    // Sort the list
    const sorted = [...list].sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];
        
        // Handle numeric columns
        if (sortColumn === 'width' || sortColumn === 'height') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        }
        
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });
    
    tbody.innerHTML = sorted.map(s => `
        <tr onclick="selectSignage('${s.code}')">
            <td class="code-cell">${s.code}</td>
            <td>${s.station || '-'}</td>
            <td>${s.width}m</td>
            <td>${s.height}m</td>
            <td>${s.illumination === 'Yes' ? 'üí° Illuminated' : 'Standard'}</td>
            <td><span class="signage-status ${s.status.toLowerCase()}">${s.status}</span></td>
        </tr>
    `).join('');
}

    function selectSignage(code) {
        selectedSignage = signageByCode[code];
        document.getElementById('selectedSignageInfo').innerHTML = `
<div class="signage-card selected">
<div class="signage-code">${

        selectedSignage.code}</div>
<div class="signage-specs">
<div>üìè ${

        selectedSignage.width}m √ó ${selectedSignage.height}m</div>
<div>üí° ${selectedSignage.illumination === 'Yes' ? 'Illuminated' : 'Standard'}</div>
</div>
</div>
`





        ;
        document.getElementById('workerStep1').classList.remove('active');
        document.getElementById('workerStep2').classList.add('active');
    }

    function backToList() {
        document.getElementById('workerStep2').classList.remove('active');
        document.getElementById('workerStep1').classList.add('active');
        document.getElementById('preview').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'none';
        selectedSignage = null;
        selectedImage = null;
    }

    document.getElementById('fileInput').onchange = function (e) {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  selectedFile = file; // ‚úÖ store actual file

  // show preview
  selectedImage = URL.createObjectURL(file);
  const img = document.getElementById('preview');
  img.src = selectedImage;
  img.style.display = "block";

  document.getElementById('submitBtn').style.display = "block";
};


  async function submitUpload(){
  if(!selectedSignage || !selectedFile){
    alert("No image selected.");
    return;
  }

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.textContent = "Uploading...";

  try {
    const ext = selectedFile.name.split('.').pop().toLowerCase();
    const safeCode = selectedSignage.code.replace(/[^A-Za-z0-9-_]/g, "_");
    const filename = `${safeCode}/${Date.now()}.${ext}`;

    // ‚úÖ Upload original file directly to Supabase
    const { data, error: uploadError } = await sb.storage
      .from("uploads")
      .upload(filename, selectedFile, {
        contentType: selectedFile.type || "image/jpeg",
      });

    if (uploadError) throw uploadError;

    const { data: publicData } = sb.storage.from("uploads").getPublicUrl(filename);

    // ‚úÖ Add DB entry
    const { error: dbError } = await sb.from("uploads").insert({
      code: selectedSignage.code,
      image_url: publicData.publicUrl,
      status: "pending",
    });

    if (dbError) throw dbError;

    alert("‚úÖ Photo uploaded!");
    backToList();
    await loadData();
  } catch (err) {
    alert("‚ùå Error uploading image: " + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "Submit Photo";
  }
}

    async function addSignage() {
        const code = document.getElementById('newCode').value.trim();
        const width = document.getElementById('newWidth').value;
        const height = document.getElementById('newHeight').value;
        const illum = document.getElementById('newIllumination').value;
        if (!code || !width || !height || !illum) {
            alert('Please fill all fields');
            return;
        }
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'addSignage',
                    code,
                    width,
                    height,
                    illumination: illum
                })
            });
            document.getElementById('supervisorMessage').innerHTML = '<div class="success">‚úÖ Signage added!</div>';
            document.getElementById('newCode').value = '';
            document.getElementById('newWidth').value = '';
            document.getElementById('newHeight').value = '';
            document.getElementById('newIllumination').value = '';
            setTimeout(() => document.getElementById('supervisorMessage').innerHTML = '', 3000);
            setTimeout(loadData, 2000);
        } catch (err) {
            alert('Error adding signage');
        }
    }

function setView(view){
  currentView=view;
  document.querySelectorAll('.view-tab').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  resetPagination();
  loadGallery();
}
    function loadGallery(){
  const container=document.getElementById('gallery');
  const empty=document.getElementById('emptyGallery');

  // Ensure we have the correct filtered list
  if (!itemsForView.length) {
    itemsForView = (currentView==='all') ? allUploads : allUploads.filter(u=>u.status===currentView);
  }

  if(itemsForView.length===0){
    container.innerHTML='';
    empty.style.display='block';
    return;
  }
  empty.style.display='none';

  // Slice for current page
  const slice = itemsForView.slice(0, PAGE_SIZE*page);

  const fragment=document.createDocumentFragment();
  container.innerHTML=''; // re-render current slice
  slice.forEach((u,i)=>{
    const signage=signageByCode[u.code]||{};
    const url = (u.image_url || u.imageUrl || '');
const thumbUrl = convertDriveUrl(url);

    const div=document.createElement('div');
    div.className='gallery-item';
    div.innerHTML=`<img data-src="${thumbUrl}" loading="lazy" decoding="async" fetchpriority="low" onclick="window.open('${url}','_blank')">
<div class="gallery-item-info">
  <div class="gallery-item-code">${u.code}</div>
  <div class="gallery-item-specs">üìè ${signage.width||'?'}m √ó ${signage.height||'?'}m | üí° ${signage.illumination||'?'}</div>
  <div class="gallery-item-specs">üìÖ ${new Date(u.upload_date || u.uploadDate).toLocaleDateString()}</div>
  <span class="status ${u.status}">${u.status.toUpperCase()}</span>
  <a href="${url}" target="_blank" class="drive-link">üìÇ Open in Drive</a>
  ${currentRole==='supervisor'&&u.status==='pending'?`
  <div class="action-btns">
    <button class="approve-btn" onclick="updateStatus('${u.code}','approved','${i}')">‚úì Approve</button>
    <button class="reject-btn" onclick="toggleRejectInput(${i})">‚úó Reject</button>
  </div>
  <input type="text" id="comment${i}" class="comment-input" placeholder="Rejection reason...">
  <button id="rejectConfirm${i}" style="display:none;background:#f44336;margin-top:8px" onclick="updateStatus('${u.code}','rejected','${i}')">Confirm Reject</button>
  `:''}
  ${u.reviewComment?`<div style="margin-top:8px;font-size:12px;color:#721C24;background:#F8D7DA;padding:8px;border-radius:4px">üí¨ ${u.reviewComment}</div>`:''}
</div>`;
    fragment.appendChild(div);
  });
  container.appendChild(fragment);
  observeImages();
}
let scrollBound = false;
function bindScrollOnce(){
  if (scrollBound) return;
  scrollBound = true;
  window.addEventListener('scroll', () => {
    const nearBottom = window.innerHeight + window.scrollY + 200 >= document.body.offsetHeight;
    if (nearBottom) {
      const totalPages = Math.ceil(itemsForView.length / PAGE_SIZE);
      if (page < totalPages) { page++; loadGallery(); }
    }
  });
}
bindScrollOnce();
    function toggleRejectInput(idx) {
        const input = document.getElementById('comment' + idx);
        const btn = document.getElementById('rejectConfirm' + idx);
        input.style.display = 'block';
        btn.style.display = 'block';
        input.focus();
    }

    async function updateStatus(code, status, idx) {
        let comment = '';
        if (status === 'rejected') {
            comment = document.getElementById('comment' + idx).value.trim();
            if (!comment) {
                alert('Please enter rejection reason');
                return;
            }
        }
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'updateStatus',
                    code,
                    status,
                    comment,
                    reviewedBy: 'Supervisor'
                })
            });
            alert('‚úÖ Status updated!');
loadData();        } catch (err) {
            alert('Error updating status');
        }
    }

    function openModal(src) {
        window.open(src, '_blank');
    }

    function closeModal() {
        document.getElementById('imageModal').classList.remove('active');
    }

    window.selectSignage = selectSignage;
        window.sortTable = sortTable;
    window.setRole = setRole;
    window.setView = setView;
        window.populateFilters = populateFilters;
    window.applyFilters = applyFilters;
    window.submitUpload = submitUpload;
    window.addSignage = addSignage;
    window.updateStatus = updateStatus;
    window.toggleRejectInput = toggleRejectInput;
    window.backToList = backToList;
    const imgObserver = new IntersectionObserver((entries) => {
        entries.forEach(e => {
            if (e.isIntersecting) {
                const img = e.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                imgObserver.unobserve(img);
            }
        });
    }, {
        rootMargin: '50px'
    });

    function observeImages() {
        document.querySelectorAll('img[data-src]').forEach(img => imgObserver.observe(img));
    }
    loadData();
    </script>
</body>
</html>
